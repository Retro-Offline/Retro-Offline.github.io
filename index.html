<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image to Minecraft JSON</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #222; color: #eee; }
    input, select, textarea, button { margin: 5px 0; padding: 6px; font-size: 14px; }
    label { display: block; margin-top: 10px; }
    textarea { width: 100%; height: 200px; white-space: pre; background: #111; color: #0f0; }
    .preview { background: #111; padding: 10px; margin-top: 10px; white-space: pre; border: 1px solid #444; }
    #bookWarning { color: orange; display: none; }
  </style>
</head>
<body>
  <h2>üñºÔ∏è Image to Minecraft Colored JSON Tool</h2>

  <label>Upload Image:
    <input type="file" id="imgInput" accept="image/*">
  </label>

  <label id="rowLabel">Rows: <input type="number" id="rows" value="14" min="1" max="64"></label>
  <label id="colLabel">Pixels Per Row: <input type="number" id="cols" value="12" min="1" max="64"></label>
  <div id="bookWarning">‚ö†Ô∏è Book mode max: 14 rows x 12 pixels</div>

  <label>Pixel Character:
    <select id="charSelect">
      <option value="‚ñà">‚ñà</option>
      <option value="‚ñ†">‚ñ†</option>
      <option value="custom">Custom...</option>
    </select>
    <input type="text" id="customChar" value="@" maxlength="1" style="display:none; margin-left: 10px;">
  </label>

  <label>Output Mode:
    <select id="mode">
      <option value="raw">Raw</option>
      <option value="tellraw">Tellraw</option>
      <option value="book">Book</option>
      <option value="textdisplay">Text Display</option>
    </select>
  </label>

  <div id="bookFields" style="display: none;">
    <label>Book Title: <input type="text" id="bookTitle" value="Pixel Image"></label>
    <label>Book Author: <input type="text" id="bookAuthor" value="ImageTool"></label>
  </div>

  <button onclick="processImage()">Generate JSON</button>

  <h3>üìú Output</h3>
  <textarea id="output"></textarea>

  <h3>üëÅÔ∏è Preview</h3>
  <div class="preview" id="previewBox"></div>

  <canvas id="canvas" style="display:none;"></canvas>

<script>
document.getElementById("mode").addEventListener("change", function () {
  const bookFields = document.getElementById("bookFields");
  const bookWarning = document.getElementById("bookWarning");
  bookFields.style.display = this.value === "book" ? "block" : "none";
  bookWarning.style.display = this.value === "book" ? "block" : "none";
});

document.getElementById("charSelect").addEventListener("change", function () {
  const customCharInput = document.getElementById("customChar");
  customCharInput.style.display = this.value === "custom" ? "inline-block" : "none";
});

function getColorHex(r, g, b) {
  return "#" + [r, g, b].map(x => x.toString(16).padStart(2, "0")).join("");
}

function getSelectedChar() {
  const select = document.getElementById("charSelect");
  const value = select.value;
  if (value === "custom") {
    const custom = document.getElementById("customChar").value;
    return custom || "@";
  }
  return value;
}

function processImage() {
  const file = document.getElementById("imgInput").files[0];
  const rows = parseInt(document.getElementById("rows").value);
  const cols = parseInt(document.getElementById("cols").value);
  const pixelChar = getSelectedChar();
  const mode = document.getElementById("mode").value;
  const title = document.getElementById("bookTitle").value;
  const author = document.getElementById("bookAuthor").value;

  if (!file) return alert("Please upload an image first.");

  const reader = new FileReader();
  reader.onload = function (e) {
    const img = new Image();
    img.onload = function () {
      const canvas = document.getElementById("canvas");
      canvas.width = cols;
      canvas.height = rows;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, cols, rows);
      const data = ctx.getImageData(0, 0, cols, rows).data;

      const grid = [];
      for (let y = 0; y < rows; y++) {
        const line = [];
        for (let x = 0; x < cols; x++) {
          const i = (y * cols + x) * 4;
          const [r, g, b, a] = data.slice(i, i + 4);
          if (a < 10) continue;
          const color = getColorHex(r, g, b);
          line.push({ text: pixelChar, color });
        }
        grid.push(line);
      }

      let output = "";
      let preview = "";

      if (mode === "raw") {
        output = JSON.stringify(grid, null, 2);
        preview = grid.map(row => row.map(px => px.text).join("")).join("\n");
      } else if (mode === "tellraw") {
        const components = grid.map(row => ({
          text: "\n",
          extra: row.map(px => ({ text: px.text, color: px.color }))
        }));
        output = `/tellraw @p ${JSON.stringify(components)}`;
        preview = grid.map(row => row.map(px => px.text).join("")).join("\n");
      } else if (mode === "book") {
        const pages = [];
        for (let i = 0; i < grid.length; i += 14) {
          const page = [];
          for (let y = 0; y < 14; y++) {
            const row = grid[i + y];
            if (row) {
              page.push(...row, { text: "\n" });
            }
          }
          pages.push(JSON.stringify(page));
        }

        output = `give @p written_book[written_book_content={author:"${author}",pages:[${pages.join(",")}],title:"${title}"}]`;
        preview = `Pages: ${pages.length}\n` + grid.map(row => row.map(px => px.text).join("")).join("\n");
      } else if (mode === "textdisplay") {
        const components = [];
        grid.forEach((row, idx) => {
          row.forEach(px => components.push({ text: px.text, color: px.color }));
          components.push({ text: "\n" });
        });
        output = `summon text_display ~ ~ ~ {line_width:2147483647,text:${JSON.stringify(components)}}`;
        preview = grid.map(row => row.map(px => px.text).join("")).join("\n");
      }

      document.getElementById("output").value = output;

      // Colored Preview
      if (mode === "raw") {
        document.getElementById("previewBox").innerText = preview;
      } else {
        const htmlPreview = grid.map(row =>
          row.map(px => `<span style='color:${px.color}'>${px.text}</span>`).join("")
        ).join("<br>");
        document.getElementById("previewBox").innerHTML = htmlPreview;
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
